---
title: HBase
date: 2023-07-10 11:35:38
updated: 2023-07-10 11:35:38
categories: bigdata
tags: HBase
description: HBase
---

### 简介
HBase 是 bigtable 的开源山寨版本，是建立在 hdfs 之上，提供**高可靠**、**高性能**、**列存储**、**可伸缩**、**实时读写**的数据库系统。
它介于 nosql 和 RDBMS 之间，仅能通过主键（row key）或主键的 range 来检索数据，仅支持单行事务，主要用来存储非结构化或半结化数据。

### Features
1. big

   一个表可以有上亿行上百万列
2. column orient

    面向列（族）的存储和权限控制，列（族）独立检索
3. 稀疏 sparse

    对于为空(null)的列，并不占用存储空间，因此，表可以设计的非常稀疏
    
### 逻辑视图
![HBase逻辑视图](HBase.png)

#### row key
访问 HBase 中的数据只有三种方式
1. by single row key
2. range of row key
3. scan entire table

Row key 可以是任意字符串（最大长度64KB）， 在 HBase 内部 row key 保存为字节数组，存储时，数据按照 row key 的字典序（byte order）排序存储。

注意：字典序对int的排序结果如下，1，10，100，11，12，2，20，21，...，9，91，要保持整型的自然序，row key
必须用0作左填充。

行的一次读写是原子操作。

#### 列族
HBase 表中的每个列都归属于某个列族，列族是表 schema 的一部分，而列不是，必须在使用之前定义，列名都以列族作为前缀。

**访问控制、磁盘和内存的使用统计都是在列族层面进行的**。实际应用中，列族上的控制权限能帮助管理不同类型的应用。

#### 时间戳
HBase 中通过 row key 和 column 确定的一个存储单元称为 cell，每个 cell 都保存同一份数据的多个版本。版本通过时间戳来索引。时间戳的类型是64
位整型，时间戳可以由 HBase 在写入时自动生成，也可以由客户端显示赋值。如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳，每个 cell
中，不同版本的数据按照时间倒序排列，即最新的数据在最前面。为了避免过多的版本造成管理（存储和索引）负担，Hbase 提供了两种数据版本回收方式
**保存数据的最后N个版本**、**保存最近一段时间内的版本（近七天）**，可以针对每个列族进行设置。

#### cell

由 （row key，column=cf+column qualifier，version）唯一确定的单元，cell 中的数据没有数据类型，全部是字节码形式存储。

### 物理存储
![HBase](Table.png)

1. HBase 中行按 row key 的字典序排列
2. Table 在行的方向上分割为多个 Hregion
3. region 按大小分割的，每个表一开始只有一个 region，随着数据不断插入表，region 不断增大，当增大到一定阈值的时候，Hregion 就会等分为两个新的Hregion，当 Table 中的行不断增多，Hregion 就会越来越多
4. Hregion 是 HBase 中分布式存储和负载均衡的最小单元，意味着 Hregion 可以分布在不同的 Hregion server 上，但一个 Hregion 是不会拆分到多个 server 上的
5. Hregion 虽然是分布式存储的最小单元，但并不是存储的最小单元，事实上，Hregion 由一个或多个 Store 组成，每个 Store 保存一个列族，每个 Store 由一个 memStore 和 0或多个 StoreFile 组成，StoreFile 以 Hfile 格式存储在 HDFS 上 

#### HFile
六部分组成
##### 1. Data Block 段
保存表中的数据，这部分可以被压缩
##### 2. Meta Block 段
可选的，保存用户自定义的kv对，可以被压缩
##### 3. File info 段
Hfile 元信息，不被压缩，用户可以在这一部分添加自己的元信息
##### 4. Data Block Index 段
Data Block 的索引，每条索引的 key 是被索引的 block 的第一条记录的 key
##### 5. Meta Block Index 段
可选的，Meta Block 的索引
##### 6. Trailer
这一段是定长的，保存了每一段的偏移量，读取一个 Hfile 时，会优先读取 Trailer，Trailer 保存了每个段的起始位置（段的 Magic Number 用来做安全check），然后
，Data Block Index 会被读取到内存中，这样当检索某个 key 时，不需要扫描整个 Hfile，而只需从内存中找到 key 所在的 block，通过一次磁盘 IO 将整个 block 读
取到内存中，再找需要的 key，Data Block Index 采用 LRU 机制淘汰。

Hfile 的 Data Block，Meta Block 通常采用压缩方式存储，压缩之后可以大大减少网络和磁盘 IO，随之而来的开销当然是需要花费 CPU 进行压缩和解压缩。

### HLog （WAL log）
WAL Write-ahead logging 预写式日志，类似 MySQL 中的 binlog，用来做灾难恢复，HLog 记录数据的所有变更，一旦数据修改，就可以从 log 中恢复。

每个 Region Server 维护一个 HLog 而不是每个 Region 一个，这样不同 Region （来自不同的 table）的日志会混在一起，这样做的目的是不断追加单个文件相对于
写多个文件而言，可以减少磁盘寻址次数，因此可以提高对 table 的写性能，带来的麻烦是，如果一台 Region Server 下线，为了恢复其上的 Region，需要将 Region 
Server 上的 log 进行拆分，然后分发到其它 Region Server 上进行恢复。

HLog 文件就是一个普通的 Hadoop Sequence File，Sequence File 的 key 是 HLogKey 对象，记录了写入数据的归属信息，除了 table 和 Region 名外，
同时还包括 Sequence number 和 timestamp（写入时间），Sequence number 的起始值为0，或者是最近一次存入文件系统中 Sequence number，HLogSequenceFile
的 Value 是 HBase 的 KeyValue 对象。
