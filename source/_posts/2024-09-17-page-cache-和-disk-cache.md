---
title: page cache 和 disk cache
date: 2024-09-17 20:00:43
updated: 2024-09-17 20:00:43
categories: 操作系统
tags: [linux]
description: page cache and disk cache 
---

## page cache and disk cache
Disk cache 和 page cache 是相关但不同的概念，它们在功能上有所重叠，但技术细节和应用层面有所不同。

以下是它们的区别和联系：

### Page Cache（页面缓存）：
- 定义：由操作系统内核管理的内存区域，用于缓存文件系统中的数据。它缓存的是文件的内容，即文件系统层面的数据。每次文件被读取时，数据会首先进入页面缓存，从而减少对磁盘的直接访问。
- 作用：主要用于缓存文件的内容，以加速后续的读写操作。如果某个文件已经在页面缓存中，下次读取该文件时，可以直接从缓存中读取，而无需访问磁盘，从而减少磁盘I/O。
- 场景：与文件系统相关联，主要针对文件级别的数据缓存。
- 实现方式：操作系统的内核自动管理，通常通过虚拟内存的一部分作为页面缓存。
### Disk Cache（磁盘缓存）：
- 定义：通常指的是磁盘驱动器自身的缓存，尤其是硬盘（HDD）或固态硬盘（SSD）内置的缓存。这些缓存是硬件层面的，由磁盘控制器管理，旨在加速磁盘读写操作。
- 作用：用于缓存磁盘块的读写数据。当系统请求读写数据时，磁盘会先将数据存入自身的高速缓存中（通常为静态RAM，容量较小，几MB到几百MB不等），从而加速传输。对于写操作，磁盘缓存可以先将数据临时存储，稍后再写入磁盘，减少写操作的延迟。
- 场景：硬件层面的缓存，作用在块设备级别。
- 实现方式：磁盘驱动器上的硬件控制器负责管理这部分缓存。
### 主要区别
#### 管理层面
- Page Cache：由操作系统内核管理，用于缓存文件系统的数据。
- Disk Cache：由硬件（磁盘控制器）管理，直接作用于物理磁盘的读写操作。
#### 缓存的数据类型
- Page Cache：缓存的是文件系统中的文件内容，主要是逻辑文件数据。
- Disk Cache：缓存的是物理磁盘块，直接与硬盘的物理读写操作相关。
#### 位置
- Page Cache：在系统内存（RAM）中，由操作系统的虚拟内存管理部分负责。
- Disk Cache：在磁盘本身内置的缓存中，通常是硬盘或SSD的控制器进行管理。
#### 缓存作用的层次
- Page Cache：高层次缓存，位于操作系统的文件系统层。
- Disk Cache：底层缓存，位于硬件的物理磁盘控制器层。
### 联系
尽管这两种缓存处于不同的层次，但它们有时会协同工作。例如：
当系统从磁盘读取文件时，数据会首先经过 Disk Cache（如果磁盘控制器缓存了数据），再进入 Page Cache。下次访问同一数据时，可以直接从Page Cache中读取。
当写入数据时，Disk Cache 和 Page Cache 也可能都临时存储数据，从而加速写操作。
### 总结
Disk cache 和 page cache 并不是完全相同的东西，它们作用在不同的层面。Disk cache 是硬件级的缓存，由磁盘控制器管理，作用于磁盘块级别；而 page cache 是操作系统内核管理的缓存，作用于文件系统的内容。在现代系统中，这两种缓存通常协同工作，共同提高读写性能。
 
### disk cache 是什么
磁盘缓存（disk cache）是计算机系统中的一块高速存储区域，用于加速数据的读取和写入操作。它通常通过在内存（RAM）中存储最近从磁盘读取的数据，减少对磁盘的频繁访问，从而提高系统性能。

磁盘缓存的工作原理包括以下几方面：

- 数据预读取：当系统读取某个数据块时，磁盘缓存会将相邻的数据块也加载到缓存中，假设这些数据可能会很快被访问到。
- 写缓存：当系统要写入数据时，磁盘缓存会先将数据临时存放在缓存中，然后再批量写入磁盘，从而减少磁盘的写操作。
- 缓存命中：当系统请求的数据已经存在于磁盘缓存中时，数据直接从缓存中返回，避免了磁盘访问，从而大幅减少读写延迟。

### 磁盘缓存一般分为两种
- 硬件级缓存：内置在硬盘或SSD中的缓存，通常是专用的静态RAM（SRAM），容量较小（几MB到几百MB不等），用于加速数据传输。
- 操作系统级缓存：操作系统使用部分内存作为磁盘缓存，以减少频繁的磁盘访问。

## 如何保证一致性
操作系统级的缓存怎么保证数据一致性，比如写数据时，数据缓存在ram中，此时突然停电，这部分数据不就丢失了吗？


操作系统级的缓存通过多种机制来保证数据一致性，尤其是在突然断电或系统崩溃的情况下，以减少数据丢失的风险。下面是一些常见的技术手段：

### 写入策略
操作系统级缓存在写数据时通常有两种策略：
- Write-through（直写模式）：数据在写入缓存的同时，立即同步写入磁盘。这种方式确保了数据在写入时立即持久化到磁盘上，即使系统突然断电，缓存中的数据已经写到磁盘，不会丢失。然而，这种方式的写性能较低，因为每次写操作都需要等待磁盘完成。
- Write-back（延迟写/回写模式）：数据先写入缓存，之后再批量写入磁盘。这种方式提高了性能，但存在风险——如果在数据从缓存写入磁盘之前系统发生故障，数据可能会丢失。为了降低这个风险，操作系统会引入其他机制来保证一致性。

### 文件系统的同步机制
操作系统和文件系统提供了同步（sync）操作，用于强制将缓存中的数据写入磁盘。常见的方式包括：
- 定期同步：操作系统会在一定的时间间隔（5秒）内自动执行同步操作，将缓存中的数据写入磁盘。这种机制可以减少数据丢失的窗口时间。
- 手动同步：应用程序或管理员可以使用系统调用（如 fsync 或 sync）手动触发数据同步，确保数据从缓存写入磁盘。

### 日志文件系统 Journaling Filesystem
大多数现代操作系统使用日志文件系统（如 ext4、XFS、NTFS 等）来进一步保证数据一致性。日志文件系统在执行写操作之前，先将即将写入的数据记录到一个独立的日志中，这称为日志记录或元数据写入。如果系统在写操作过程中崩溃或断电，系统可以通过日志恢复未完成的操作，从而保证数据一致性。

工作流程：
- 数据先写入日志并标记为即将执行。
- 当日志成功写入后，才会实际写入文件系统。
- 最后更新日志，标记该操作完成。

### 非易失性缓存
一些存储设备，如企业级的硬盘和固态硬盘（SSD），配备了非易失性缓存（如电池备份缓存或使用非易失性内存技术），即使在断电时，缓存中的数据也不会丢失。这可以保证缓存中的数据在系统恢复时仍然可以安全地写入磁盘。

### UPS 不间断电源
在数据中心等关键环境中，通常会使用UPS（不间断电源）等硬件设施来防止突然断电对系统造成影响，从而保证操作系统有足够时间将缓存中的数据写入磁盘。

### 总结
1. 操作系统通过写入策略（如 write-through 或 write-back）、定期同步机制、日志文件系统等方式来减少数据丢失的可能性。
2. 对于关键任务应用，管理员或程序应结合这些机制，主动执行数据同步或采用 UPS 等硬件解决方案来进一步提高数据的可靠性。

## page cache
操作系统提供的这种功能在学术上通常被称为页面缓存（Page Cache）。它是操作系统内存管理的一部分，专门用于缓存从磁盘读取的数据，以提高读写性能。
### 页面缓存的关键点
- 读缓存：当操作系统读取文件时，会将文件的页面缓存在内存中。下次访问相同的文件时，数据可以直接从内存中读取，避免磁盘I/O，从而加速文件访问。
- 写缓存：当数据写入文件时，操作系统并不会立即将其写入磁盘，而是先将数据保存在页面缓存中（这就是所谓的“延迟写”或“写回缓存”）。随后在适当的时候，操作系统会将这些数据批量写入磁盘。
### 页面缓存的特点
- 透明性：对于应用程序而言，页面缓存的操作是透明的，应用程序无需感知缓存的存在。
- 提高性能：通过减少磁盘I/O次数，页面缓存显著提高了读写操作的性能，尤其是在大量重复读写同一文件或区域时。
### 页面缓存与缓冲区缓存的区别
- 页面缓存：用于缓存文件系统的数据页。
- 缓冲区缓存：通常与块设备相关，缓存的是块设备层的数据（如磁盘块）。

操作系统中的实现：在Linux中，页面缓存由内核管理，所有文件系统的文件操作都会通过页面缓存机制进行优化。

## 页面缓存是由内核提供的而不是文件系统
页面缓存（Page Cache）是由操作系统内核提供的，而不是由文件系统直接提供的功能。虽然页面缓存用于优化文件系统的读写操作，但它是操作系统内存管理的一部分，独立于具体的文件系统。

### 内核负责管理页面缓存
页面缓存是在内核层面实现的，内核为所有文件系统提供统一的缓存机制。当应用程序读取或写入文件时，数据会通过内核的页面缓存进行缓存。

### 文件系统使用内核的缓存机制
文件系统不会自己管理缓存，而是依赖操作系统的内核来管理缓存。不同的文件系统在使用内核提供的页面缓存时，表现出一致的行为，无论是ext4、NTFS还是其他文件系统，它们都依赖内核的缓存机制。

### 页面缓存独立于具体的文件系统
页面缓存为所有文件系统提供了一个通用的接口。文件系统负责组织数据的布局和存取规则，但实际的缓存逻辑（如数据是否缓存、何时从缓存中读取、何时写回磁盘）是由操作系统内核负责的。

### 统一的内存管理
页面缓存与虚拟内存管理密切相关，内核会将一部分内存用于页面缓存，以提高文件操作的效率。当系统内存不足时，内核会自动调整缓存大小或释放缓存中的数据来确保系统的稳定运行。

## 怎么查看 page cache
在Linux系统中，可以通过多种方式查看和管理页面缓存（page cache）的使用情况。以下是常用的几种方法：

### 查看页面缓存的统计信息
#### free
通过 free 命令可以查看系统页面缓存的大小。`free -h`

buff/cache：表示内核用于缓冲区缓存和页面缓存的内存大小。

#### vmstat
`vmstat -s`

#### cat /proc/meminfo 
cat /proc/meminfo | grep -i -e "cached" -e "Buffers"

Buffers：表示块设备（如硬盘）使用的缓冲区缓存。
Cached：表示文件系统使用的页面缓存。

## 清理页面缓存
有时可能希望手动清理页面缓存，特别是在进行性能测试时。可以通过以下命令来清除页面缓存（需要root权限）：
```shell
sudo sync       # 确保所有数据写入磁盘
sudo echo 1 > /proc/sys/vm/drop_caches   # 清理页面缓存
sudo echo 2 > /proc/sys/vm/drop_caches   # 清理 dentries 和 inodes 缓存
sudo echo 3 > /proc/sys/vm/drop_caches   # 清理所有缓存
```

## 页面缓存和缓冲区缓存的区别
页面缓存（Page Cache）和缓冲区缓存（Buffer Cache）是操作系统内存管理中的两种不同的缓存机制，虽然它们有相似之处，都旨在提高读写操作的效率，但它们处理的数据类型和应用场景有所不同。以下是两者的主要区别：

### 缓存对象
- 页面缓存（Page Cache）：主要用于文件系统中的文件数据，它缓存的是文件内容，即应用程序读取和写入的文件数据，每当应用程序访问文件时，文件内容会被加载到页面缓存中，以便后续访问可以直接从内存中读取，减少磁盘 I/O 操作。
- 缓冲区缓存（Buffer Cache）：主要用于块设备的数据，例如硬盘块（block devices）。它缓存的是文件系统元数据（如目录、超级块等）和磁盘块本身。这部分缓存主要与设备的物理层数据交互，是块设备操作的缓存层。
### 缓存的层次
- 页面缓存：作用于文件系统层。当文件被读取或写入时，操作系统将文件数据放在页面缓存中，因此页面缓存用于逻辑文件的缓存。
- 缓冲区缓存：作用于块设备层，是操作系统在与块设备交互时使用的缓存。它保存设备的块数据，主要是物理块层次上的信息。
### 缓存的数据类型
- 页面缓存：缓存文件内容，专门处理文件的用户数据。例如，当你打开一个文本文件或图像文件时，文件内容会首先进入页面缓存。
- 缓冲区缓存：缓存文件系统的元数据和磁盘块的数据。例如，文件系统结构的元信息、磁盘块的内容（如目录项和索引节点）等。
### 管理方式
- 页面缓存：由操作系统内核通过虚拟内存管理，通常通过文件系统接口来管理。当应用程序请求读写文件时，操作系统首先查找页面缓存，查看是否已经缓存了该文件的数据。
- 缓冲区缓存：与块设备驱动相关，由操作系统块设备管理器控制。当操作系统执行块设备级别的读写操作时，缓冲区缓存起作用。
### 应用场景
- 页面缓存：主要用于提高文件操作的效率，特别是当多个程序频繁访问相同文件时。它使得文件系统读写操作更快，因为文件内容可以在缓存中重用。
- 缓冲区缓存：主要用于提高磁盘块的读写效率，特别是在文件系统的元数据操作时，缓冲区缓存用于减少磁盘I/O操作。例如，在写入文件时，缓冲区缓存可以缓存文件系统的目录结构、索引节点等数据。
### 数据一致性
- 页面缓存：文件系统层的缓存，因此它的数据一致性通常由文件系统的同步机制控制。脏页（修改后尚未写入磁盘的页面）会在适当时刻写入磁盘。
- 缓冲区缓存：与块设备交互，因此数据一致性与设备的同步机制相关。缓冲区缓存的数据通常会通过 sync 命令或内核后台进程定期同步到磁盘。
sync 命令能同时同步这两个内存。
### 具体实现
在Linux中：页面缓存负责缓存文件的内容，而缓冲区缓存负责缓存磁盘块和文件系统元数据。可以通过 /proc/meminfo 中的 Buffers 和 Cached 字段来分别查看缓冲区缓存和页面缓存的大小。

### 总结
- 页面缓存：缓存的是文件系统中的文件内容，应用于逻辑文件操作层。
- 缓冲区缓存：缓存的是块设备的数据和文件系统的元数据，应用于块设备操作层。

这两种缓存机制共同作用于操作系统的存储管理，提升文件系统和块设备的性能。

## buff/cache
buff/cache buff=缓冲区缓存 page=页面缓存。

buff/cache 字段在 free -h 命令输出中显示的是两个不同的缓存机制的总和，即缓冲区缓存（Buffer Cache）和页面缓存（Page Cache）。它们分别执行不同的功能，但在 free 命令中被合并显示为一个值，因为它们都是操作系统用于加速数据访问的缓存。

### 具体组成
#### Buffer Cache（缓冲区缓存）
- 作用：主要用于缓存与块设备（如磁盘）交互时的元数据和块数据。
- 缓存内容：包括文件系统元数据（目录、超级块、inode）和块设备数据。它帮助减少对物理磁盘的访问，提升磁盘性能。
- 位置：位于内存中，由操作系统管理，用来处理与磁盘块交互的操作。

#### Page Cache（页面缓存）
- 作用：用于缓存文件系统中文件的实际内容（用户数据）。当系统读取或写入文件时，页面缓存会保存这些文件的数据，避免频繁的磁盘I/O操作。
- 缓存内容：文件内容，包括读取的文件数据和准备写入的文件数据。它帮助减少对文件系统的磁盘访问，提升文件操作的性能。
- 位置：也位于内存中，并由操作系统内核通过虚拟内存机制管理。

1. 为什么它们合并为一个字段（buff/cache）显示？
在 free 命令的输出中，Buffer Cache 和 Page Cache 都是系统为了优化磁盘访问和文件操作而在内存中占用的一部分。这两者的区别对用户程序来说并不直接影响内存使用的表现，因为它们都可以在需要时释放给应用程序使用。所以，free 命令将它们合并为 buff/cache 一项，表示系统中可以作为缓存使用的内存量。

2. 如何查看 Buffer Cache 和 Page Cache 的单独使用情况？
虽然 free 命令将它们合并显示，但可以通过其他方式分别查看缓冲区缓存和页面缓存的使用情况：
使用 cat /proc/meminfo：Buffers：表示缓冲区缓存的大小。Cached：表示页面缓存的大小。

## 缓冲区缓存和页面缓存一般哪个大
页面缓存（Page Cache）通常比缓冲区缓存（Buffer Cache）大。这是因为它们缓存的数据类型和使用场景不同：

1. 页面缓存（Page Cache）：
- 缓存内容：文件系统中的实际文件内容（用户数据）。
- 用途：页面缓存用于加速文件读取和写入操作，特别是当应用程序频繁访问文件时，它可以显著减少磁盘I/O负载。
- 大小：由于页面缓存主要缓存的是文件内容，现代操作系统会尽量将未使用的内存分配给页面缓存，以提高文件操作的性能。尤其是在文件访问频繁的系统上，页面缓存可能占用很大的内存空间。
2. 缓冲区缓存（Buffer Cache）：
- 缓存内容：主要缓存文件系统的元数据和与块设备相关的物理数据，如文件系统的目录结构、索引节点、超级块等。
- 用途：缓冲区缓存加速块设备的访问和文件系统元数据的管理，但由于这些元数据和块信息相对较少，缓冲区缓存的占用通常较小。
- 大小：缓冲区缓存一般不会像页面缓存那样占用大量内存，因为它只需缓存文件系统的结构和设备相关的少量数据。
### 为什么页面缓存通常更大
文件内容往往比文件系统的元数据或块设备数据大得多，因此页面缓存需要更多的内存空间来缓存文件的数据。
页面缓存的大小可以动态增长，当内存有空闲时，系统会尽量用更多的内存来缓存文件内容，以提升读写性能。
缓冲区缓存仅涉及文件系统的元数据和少量的块信息，数据量相对较小。

### 如何查看两者的大小
可以通过 /proc/meminfo 文件查看：Buffers：显示缓冲区缓存的大小。Cached：显示页面缓存的大小。
典型情况下，Cached（页面缓存）的值会比**Buffers**（缓冲区缓存）的值大很多。

总结：页面缓存一般比缓冲区缓存大得多，因为页面缓存用于缓存大量的文件数据，而缓冲区缓存主要用于缓存较少的元数据和块设备数据。

## 在 linux 中 page cache 大小是固定的吗
在 Linux 中，页面缓存（Page Cache）的大小不是固定的，而是动态调整的。操作系统会根据内存的使用情况和系统需求，自动分配和释放页面缓存的大小，以优化性能。

### 页面缓存的动态调整机制
页面缓存的大小取决于系统的内存可用性和文件访问的频率。Linux 会尽可能将空闲内存用于页面缓存，以提高文件读取和写入的性能，但当应用程序需要更多内存时，系统会自动减少页面缓存的大小，释放内存供应用程序使用。

具体来说：

- 内存充足时：操作系统会尽量使用空闲内存来缓存更多的文件数据，增加页面缓存的大小。这样可以加速文件系统的性能，减少磁盘I/O。
- 内存不足时：当应用程序需要更多的内存，而可用的空闲内存不足时，Linux 会回收页面缓存中的部分数据，以释放内存供应用程序使用。这是因为页面缓存的数据可以随时从磁盘重新加载，所以在内存紧张时优先被回收。
### 页面缓存的回收策略
Linux 内核会定期检查内存的使用情况，并通过内存管理器的 LRU（Least Recently Used） 算法逐步回收较少使用的页面缓存。脏页（已修改但尚未写回磁盘的数据）会被写回磁盘，而干净的页可以直接丢弃，以腾出空间给其他进程。

### 如何查看和管理页面缓存的使用情况
查看页面缓存大小： 通过 /proc/meminfo 文件可以查看系统中页面缓存的大小：
cat /proc/meminfo | grep Cached
Cached:         1024000 kB

清除页面缓存： 如果你想手动清理页面缓存，可以使用以下命令（需要 root 权限）：
```shell
sync # 将所有脏页同步到磁盘。
echo 1 > /proc/sys/vm/drop_caches # 清除页面缓存。
```
需要注意，清除页面缓存会导致系统性能下降，因为下一次访问文件时，需要从磁盘重新加载数据。

### 页面缓存的大小受哪些因素影响？
- 系统的总内存：内存越多，操作系统可以使用的页面缓存越多。
- 文件系统的活动：如果系统中频繁进行文件读写操作，页面缓存会增加，缓存更多的文件数据。
- 应用程序的内存需求：当应用程序需要更多的内存时，系统会自动减少页面缓存的大小，腾出内存供应用程序使用。

总结：在 Linux 中，页面缓存的大小是动态的，根据系统的内存状况和文件系统的活动自动调整。

页面缓存可以占用系统中大量的空闲内存，但当内存需求增加时，系统会自动回收缓存以满足应用程序的内存需求。

## 可以申请一个不被回收的固定大小的 page cache 吗
在 Linux 中，无法直接声明一个固定的页面缓存（Page Cache）大小，并且页面缓存的管理由操作系统内核自动进行，它会根据系统的内存需求动态调整缓存的大小。因此，操作系统通常不会允许应用程序强制锁定特定大小的页面缓存，并阻止它被回收或释放。

原因：
- 页面缓存是全局的：页面缓存是由内核统一管理的共享资源，它是针对整个系统的，而不是为单个应用程序独立分配。操作系统会根据整体内存状况和应用需求来动态分配和回收页面缓存。
- 内存回收机制：当系统内存紧张时，Linux 内核会通过回收页面缓存来腾出内存以供应用程序使用。这是 Linux 内存管理的基本策略，因此即使有空闲内存，内核也可能回收页面缓存。
- 公平性和资源管理：内核的内存管理策略确保系统中的各个应用程序能够公平地使用系统资源，锁定特定的页面缓存大小会影响整个系统的内存管理，可能会导致其他应用程序无法获取足够的内存。

