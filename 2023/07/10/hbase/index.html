<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zjd-melo.github.io","root":"/blog/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="HBase">
<meta property="og:type" content="article">
<meta property="og:title" content="HBase">
<meta property="og:url" content="https://zjd-melo.github.io/blog/2023/07/10/hbase/index.html">
<meta property="og:site_name" content="Dying Memory">
<meta property="og:description" content="HBase">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zjd-melo.github.io/blog/2023/07/10/hbase/hbase.png">
<meta property="og:image" content="https://zjd-melo.github.io/blog/2023/07/10/hbase/Table.png">
<meta property="article:published_time" content="2023-07-10T03:35:38.000Z">
<meta property="article:modified_time" content="2023-07-17T11:47:00.000Z">
<meta property="article:author" content="朱佳东">
<meta property="article:tag" content="HBase">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zjd-melo.github.io/blog/2023/07/10/hbase/hbase.png">

<link rel="canonical" href="https://zjd-melo.github.io/blog/2023/07/10/hbase/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh_CN'
  };
</script>

  <title>HBase | Dying Memory</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Dying Memory</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Keep moving</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">14</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/zjd-melo" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh_CN">
    <link itemprop="mainEntityOfPage" href="https://zjd-melo.github.io/blog/2023/07/10/hbase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.png">
      <meta itemprop="name" content="朱佳东">
      <meta itemprop="description" content="melon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dying Memory">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HBase
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-10 11:35:38" itemprop="dateCreated datePublished" datetime="2023-07-10T11:35:38+08:00">2023-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-17 19:47:00" itemprop="dateModified" datetime="2023-07-17T19:47:00+08:00">2023-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>
            <div class="post-description">HBase</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>HBase 是 bigtable 的开源山寨版本，是建立在 hdfs 之上，提供<strong>高可靠</strong>、<strong>高性能</strong>、<strong>列存储</strong>、<strong>可伸缩</strong>、<strong>实时读写</strong>的数据库系统。<br>它介于 nosql 和 RDBMS 之间，仅能通过主键（row key）或主键的 range 来检索数据，仅支持单行事务，主要用来存储非结构化或半结化数据。</p>
<h3 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h3><ol>
<li><p>big</p>
<p>一个表可以有上亿行上百万列</p>
</li>
<li><p>column orient</p>
<p> 面向列（族）的存储和权限控制，列（族）独立检索</p>
</li>
<li><p>稀疏 sparse</p>
<p> 对于为空(null)的列，并不占用存储空间，因此，表可以设计的非常稀疏</p>
</li>
</ol>
<h3 id="逻辑视图"><a href="#逻辑视图" class="headerlink" title="逻辑视图"></a>逻辑视图</h3><p><img src="/blog/2023/07/10/hbase/hbase.png" alt="HBase逻辑视图"></p>
<h4 id="row-key"><a href="#row-key" class="headerlink" title="row key"></a>row key</h4><p>访问 HBase 中的数据只有三种方式</p>
<ol>
<li>by single row key</li>
<li>range of row key</li>
<li>scan entire table</li>
</ol>
<p>Row key 可以是任意字符串（最大长度64KB）， 在 HBase 内部 row key 保存为字节数组，存储时，数据按照 row key 的字典序（byte order）排序存储。</p>
<p>注意：字典序对int的排序结果如下，1，10，100，11，12，2，20，21，…，9，91，要保持整型的自然序，row key 必须用0作左填充。</p>
<p>行的一次读写是原子操作。</p>
<h4 id="列族"><a href="#列族" class="headerlink" title="列族"></a>列族</h4><p>HBase 表中的每个列都归属于某个列族，列族是表 schema 的一部分，而列不是，必须在使用之前定义，列名都以列族作为前缀。</p>
<p><strong>访问控制、磁盘和内存的使用统计都是在列族层面进行的</strong>。实际应用中，列族上的控制权限能帮助管理不同类型的应用。</p>
<h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h4><p>HBase 中通过 row key 和 column 确定的一个存储单元称为 cell，每个 cell 都保存同一份数据的多个版本。版本通过时间戳来索引。时间戳的类型是64位整型，时间戳可以由 HBase 在写入时自动生成，也可以由客户端显示赋值。如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳，每个 cell 中，不同版本的数据按照时间倒序排列，即最新的数据在最前面。为了避免过多的版本造成管理（存储和索引）负担，Hbase 提供了两种数据版本回收方式<strong>保存数据的最后N个版本</strong>、<strong>保存最近一段时间内的版本（近七天）</strong>，可以针对每个列族进行设置。</p>
<h4 id="cell"><a href="#cell" class="headerlink" title="cell"></a>cell</h4><p>由 （row key，column=cf+column qualifier，version）唯一确定的单元，cell 中的数据没有数据类型，全部是字节码形式存储。</p>
<h3 id="物理存储"><a href="#物理存储" class="headerlink" title="物理存储"></a>物理存储</h3><p><img src="/blog/2023/07/10/hbase/Table.png" alt="HBase"></p>
<ol>
<li>HBase 中行按 row key 的字典序排列</li>
<li>Table 在行的方向上分割为多个 Hregion</li>
<li>region 按大小分割的，每个表一开始只有一个 region，随着数据不断插入表，region 不断增大，当增大到一定阈值的时候，Hregion 就会等分为两个新的Hregion，当 Table 中的行不断增多，Hregion 就会越来越多</li>
<li>Hregion 是 HBase 中分布式存储和负载均衡的最小单元，意味着 Hregion 可以分布在不同的 Hregion server 上，但一个 Hregion 是不会拆分到多个 server 上的</li>
<li>Hregion 虽然是分布式存储的最小单元，但并不是存储的最小单元，事实上，Hregion 由一个或多个 Store 组成，每个 Store 保存一个列族，每个 Store 由一个 memStore 和 0或多个 StoreFile 组成，StoreFile 以 Hfile 格式存储在 HDFS 上</li>
</ol>
<h4 id="HFile"><a href="#HFile" class="headerlink" title="HFile"></a>HFile</h4><p>六部分组成</p>
<h5 id="1-Data-Block-段"><a href="#1-Data-Block-段" class="headerlink" title="1. Data Block 段"></a>1. Data Block 段</h5><p>保存表中的数据，这部分可以被压缩</p>
<h5 id="2-Meta-Block-段"><a href="#2-Meta-Block-段" class="headerlink" title="2. Meta Block 段"></a>2. Meta Block 段</h5><p>可选的，保存用户自定义的kv对，可以被压缩</p>
<h5 id="3-File-info-段"><a href="#3-File-info-段" class="headerlink" title="3. File info 段"></a>3. File info 段</h5><p>Hfile 元信息，不被压缩，用户可以在这一部分添加自己的元信息</p>
<h5 id="4-Data-Block-Index-段"><a href="#4-Data-Block-Index-段" class="headerlink" title="4. Data Block Index 段"></a>4. Data Block Index 段</h5><p>Data Block 的索引，每条索引的 key 是被索引的 block 的第一条记录的 key</p>
<h5 id="5-Meta-Block-Index-段"><a href="#5-Meta-Block-Index-段" class="headerlink" title="5. Meta Block Index 段"></a>5. Meta Block Index 段</h5><p>可选的，Meta Block 的索引</p>
<h5 id="6-Trailer"><a href="#6-Trailer" class="headerlink" title="6. Trailer"></a>6. Trailer</h5><p>这一段是定长的，保存了每一段的偏移量，读取一个 Hfile 时，会优先读取 Trailer，Trailer 保存了每个段的起始位置（段的 Magic Number 用来做安全check），然后 ，Data Block Index 会被读取到内存中，这样当检索某个 key 时，不需要扫描整个 Hfile，而只需从内存中找到 key 所在的 block，通过一次磁盘 IO 将整个 block 读取到内存中，再找需要的 key，Data Block Index 采用 LRU 机制淘汰。</p>
<p>Hfile 的 Data Block，Meta Block 通常采用压缩方式存储，压缩之后可以大大减少网络和磁盘 IO，随之而来的开销当然是需要花费 CPU 进行压缩和解压缩。</p>
<h4 id="HLog-（WAL-log）"><a href="#HLog-（WAL-log）" class="headerlink" title="HLog （WAL log）"></a>HLog （WAL log）</h4><p>WAL Write-ahead logging 预写式日志，类似 MySQL 中的 binlog，用来做灾难恢复，HLog 记录数据的所有变更，一旦数据修改，就可以从 log 中恢复。</p>
<p>每个 Region Server 维护一个 HLog 而不是每个 Region 一个，这样不同 Region （来自不同的 table）的日志会混在一起，这样做的目的是不断追加单个文件相对于写多个文件而言，可以减少磁盘寻址次数，因此可以提高对 table 的写性能，带来的麻烦是，如果一台 Region Server 下线，为了恢复其上的 Region，需要将 Region Server 上的 log 进行拆分，然后分发到其它 Region Server 上进行恢复。</p>
<p>HLog 文件就是一个普通的 Hadoop Sequence File，Sequence File 的 key 是 HLogKey 对象，记录了写入数据的归属信息，除了 table 和 Region 名外，同时还包括 Sequence number 和 timestamp（写入时间），Sequence number 的起始值为0，或者是最近一次存入文件系统中 Sequence number，HLogSequenceFile 的 Value 是 HBase 的 KeyValue 对象。</p>
<h3 id="物理架构"><a href="#物理架构" class="headerlink" title="物理架构"></a>物理架构</h3><h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><p>包含访问 HBase 的接口，client 维护着一些 cache 来加快对 HBase 的访问，比如 region 的位置信息</p>
<h4 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h4><ol>
<li>保证任何时候集群中只有一个 master</li>
<li>存储所有 region 的寻址入口</li>
<li>实时监控 region servers 的状态，将 region server 的上线和下线信息实时通知给 master</li>
<li>存储 HBase 的 schema，包括有哪些 table，每个 table 有哪些 column family</li>
</ol>
<h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><ol>
<li>为 region server 分配 region</li>
<li>负责 region server 的负责均衡</li>
<li>发现失效的 region server，并重新分配其上的 region</li>
<li>HDFS 上垃圾文件的回收</li>
<li>处理 schema 更新请求</li>
</ol>
<h4 id="Region-Server"><a href="#Region-Server" class="headerlink" title="Region Server"></a>Region Server</h4><ol>
<li>region server 维护 master 分配给它的 region，处理对这些 region 的 IO 请求</li>
<li>负责切分运行过程中变得过大的 region</li>
</ol>
<p>可以看到，client 访问 HBase 上的数据的过程并不需要 Master 的参与（寻址访问 zookeeper 和 region server，数据读写访问 region server），master 仅仅维护 table 和 region 的元信息，负载很低</p>
<h3 id="关键算法-x2F-流程"><a href="#关键算法-x2F-流程" class="headerlink" title="关键算法/流程"></a>关键算法/流程</h3><h4 id="读写过程"><a href="#读写过程" class="headerlink" title="读写过程"></a>读写过程</h4><p>数据在更新时首先写入 HLog （WAL）和内存（memStore）中，memStore 中的数据是排序的，当 memStore 累计到一定阈值时，就会创建一个新的 memStore，并将老的添加到 flush 队列，由单独的线程 flush 到磁盘上成为一个 StoreFile，于此同时，系统会在 zookeeper 中记录一个 redo point，表示这个时刻之前的变更已经持久化了。</p>
<p>当系统发现意外时，可能导致内存（memStore）中的数据丢失，此时使用 HLog 来恢复 checkpoint 后的数据。</p>
<p>StoreFile 是只读的，一旦创建之后不可在修改，因此对 HBase 的更新操作都是不断追加的操作，当一个 Store 中的 StoreFile 达到一定量后就会进行合并（minor compact），将对同一个 key 的修改合并在一起，此时不会删除数据，major compact 会删除数据。</p>
<ol>
<li>client 向 region server 提交写请求</li>
<li>region server 找到目标 region</li>
<li>region 检查数据是否于 schema 一致</li>
<li>如果客户端未指定版本，则获取当前系统时间作为数据版本</li>
<li>将更新写入 WAL log</li>
<li>将更新写入 memStore</li>
<li>判断 memStore 是否需要 flush</li>
</ol>
<h4 id="Region-分配"><a href="#Region-分配" class="headerlink" title="Region 分配"></a>Region 分配</h4><p>任何时刻，一个 Region 只能分配给一个 Region Server，HMaster 记录了当前有哪些 Region Server，以及当前哪些 Region 分配给了哪些 Region server，哪些 Region 还未分配，当存在未分配的 Region，并且有一个 Region Server 上有可用空间时，HMaster 就给这个 Region Server  发送一个装载请求，把 Region 分配给这个 Region Server</p>
<h4 id="Region-Server-上线"><a href="#Region-Server-上线" class="headerlink" title="Region Server 上线"></a>Region Server 上线</h4><p>HMaster 使用 zookeeper 来跟踪 Region Server 状态。当某个 Region Server 启动时，会首先在 zookeeper 上的 server 目录下建立代表自己的文件，并获得该文件的独占锁。由于 master 订阅了 server 目录上的变更消息，当 server 目录下的文件出现新增或删除操作时，master 可以得到来自 zookeeper 的实时通知。因此一旦 Region Server 上线，master能马上得到消息。</p>
<h4 id="Region-Server-下线"><a href="#Region-Server-下线" class="headerlink" title="Region Server 下线"></a>Region Server 下线</h4><p>当 Region Server 下线时，它和 zookeeper 的会话断开，zookeeper 自动释放代表这台 server 的文件上的独占锁。而 master 不断轮询 server 目录下文件的锁状态。如果 master 发现某个 Region Server 丢失了它自己的独占锁，(或者 master 连续几次和 Region Server 通信都无法成功),master 就会尝试去获取代表这个 Region Server 的读写锁，一旦获取成功，就可以确定：1、Region Server 和 zookeeper 之间的网络断开了 2、 Region Server 挂了 的其中一种情况发生了，无论哪种情况，Region Server 都无法继续为它的 region 提供服务了，此时 master 会删除 server 目录下代表这台 Region Server 的文件，并将这台 Region Server 的 region 分配给其它还活着的同志。如果网络短暂出现问题导致 Region Server 丢失了它的锁，那么 Region Server 重新连接到 zookeeper 之后，只要代表它的文件还在，它就会不断尝试获取这个文件上的锁，一旦获取到了，就可以继续提供服务。</p>
<h4 id="Hmaster-上线"><a href="#Hmaster-上线" class="headerlink" title="Hmaster 上线"></a>Hmaster 上线</h4><ol>
<li>从 zookeeper 上获取唯一一个代表 master 的锁，用来阻止其它 master 成为 master</li>
<li>扫描 zookeeper 上的 server 目录，获得当前可用的 Region Server 列表</li>
<li>和2中的每个 Region Server 通信，获得当前已分配的 region 和 Region Server 的对应关系</li>
<li>扫描.META.region的集合，计算得到当前还未分配的region，将他们放入待分配region列表</li>
</ol>
<h4 id="Hmaster-下线"><a href="#Hmaster-下线" class="headerlink" title="Hmaster 下线"></a>Hmaster 下线</h4><p>由于 master 只维护表和 region 的元数据，而不参与表数据IO的过程，master 下线仅导致所有元数据的修改被冻结(无法创建删除表，无法修改表的schema，无法进行 region 的负载均衡，无法处理 region 上下线，无法进行 region 的合并，唯一例外的是 region 的 split 可以正常进行，因为只有 Region Server参与)，表的数据读写还可以正常进行。因此 master 下线短时间内对整个 HBase 集群没有影响。从上线过程可以看到，master 保存的信息全是可以冗余信息（都可以从系统其它地方收集到或者计算出来），因此，一般hbase集群中总是有一个 master 在提供服务，还有一个以上的 master 在等待时机抢占它的位置。</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/blog/tags/HBase/" rel="tag"><i class="fa fa-tag"></i> HBase</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2023/06/12/C-2/" rel="prev" title="C-2">
      <i class="fa fa-chevron-left"></i> C-2
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2023/07/13/hbase-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" rel="next" title="HBase 常用操作">
      HBase 常用操作 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Features"><span class="nav-number">2.</span> <span class="nav-text">Features</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E8%A7%86%E5%9B%BE"><span class="nav-number">3.</span> <span class="nav-text">逻辑视图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#row-key"><span class="nav-number">3.1.</span> <span class="nav-text">row key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%97%E6%97%8F"><span class="nav-number">3.2.</span> <span class="nav-text">列族</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E6%88%B3"><span class="nav-number">3.3.</span> <span class="nav-text">时间戳</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cell"><span class="nav-number">3.4.</span> <span class="nav-text">cell</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8"><span class="nav-number">4.</span> <span class="nav-text">物理存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HFile"><span class="nav-number">4.1.</span> <span class="nav-text">HFile</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Data-Block-%E6%AE%B5"><span class="nav-number">4.1.1.</span> <span class="nav-text">1. Data Block 段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Meta-Block-%E6%AE%B5"><span class="nav-number">4.1.2.</span> <span class="nav-text">2. Meta Block 段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-File-info-%E6%AE%B5"><span class="nav-number">4.1.3.</span> <span class="nav-text">3. File info 段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-Data-Block-Index-%E6%AE%B5"><span class="nav-number">4.1.4.</span> <span class="nav-text">4. Data Block Index 段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-Meta-Block-Index-%E6%AE%B5"><span class="nav-number">4.1.5.</span> <span class="nav-text">5. Meta Block Index 段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-Trailer"><span class="nav-number">4.1.6.</span> <span class="nav-text">6. Trailer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HLog-%EF%BC%88WAL-log%EF%BC%89"><span class="nav-number">4.2.</span> <span class="nav-text">HLog （WAL log）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E6%9E%B6%E6%9E%84"><span class="nav-number">5.</span> <span class="nav-text">物理架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Client"><span class="nav-number">5.1.</span> <span class="nav-text">Client</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zookeeper"><span class="nav-number">5.2.</span> <span class="nav-text">Zookeeper</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Master"><span class="nav-number">5.3.</span> <span class="nav-text">Master</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Region-Server"><span class="nav-number">5.4.</span> <span class="nav-text">Region Server</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E7%AE%97%E6%B3%95-x2F-%E6%B5%81%E7%A8%8B"><span class="nav-number">6.</span> <span class="nav-text">关键算法&#x2F;流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E8%BF%87%E7%A8%8B"><span class="nav-number">6.1.</span> <span class="nav-text">读写过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Region-%E5%88%86%E9%85%8D"><span class="nav-number">6.2.</span> <span class="nav-text">Region 分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Region-Server-%E4%B8%8A%E7%BA%BF"><span class="nav-number">6.3.</span> <span class="nav-text">Region Server 上线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Region-Server-%E4%B8%8B%E7%BA%BF"><span class="nav-number">6.4.</span> <span class="nav-text">Region Server 下线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hmaster-%E4%B8%8A%E7%BA%BF"><span class="nav-number">6.5.</span> <span class="nav-text">Hmaster 上线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hmaster-%E4%B8%8B%E7%BA%BF"><span class="nav-number">6.6.</span> <span class="nav-text">Hmaster 下线</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="朱佳东"
      src="/blog/images/avatar.png">
  <p class="site-author-name" itemprop="name">朱佳东</p>
  <div class="site-description" itemprop="description">melon</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zjd-melo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zjd-melo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:826695779@qq.com" title="E-Mail → mailto:826695779@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朱佳东</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">64k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">58 mins.</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

</body>
</html>
